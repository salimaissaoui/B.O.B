{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "blueprint-envelope-v1",
  "title": "Blueprint Envelope",
  "description": "Unified wrapper for V1 and V2 blueprints",
  "type": "object",
  "required": ["blueprintVersion", "kind", "tags", "origin", "bounds", "estimates", "safety", "payload"],
  "properties": {
    "blueprintVersion": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of the envelope format"
    },
    "envelopeId": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this envelope"
    },
    "kind": {
      "type": "string",
      "enum": ["ops_script", "voxel_sparse", "floorplan_semantic", "asset_reference"],
      "description": "Blueprint execution strategy"
    },
    "tags": {
      "type": "object",
      "required": ["buildType"],
      "properties": {
        "buildType": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "description": "Build type classifications"
        },
        "style": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Style/theme tags"
        },
        "passes": {
          "type": "array",
          "items": { "type": "string", "enum": ["shell", "detail", "interior", "landscape"] },
          "description": "Required build passes"
        }
      }
    },
    "origin": {
      "type": "object",
      "required": ["x", "y", "z"],
      "properties": {
        "x": { "type": "integer" },
        "y": { "type": "integer" },
        "z": { "type": "integer" }
      }
    },
    "coordinateSystem": {
      "type": "string",
      "enum": ["local", "world"],
      "default": "local"
    },
    "bounds": {
      "type": "object",
      "required": ["local"],
      "properties": {
        "local": {
          "type": "object",
          "required": ["min", "max"],
          "properties": {
            "min": { "$ref": "#/definitions/position" },
            "max": { "$ref": "#/definitions/position" }
          }
        },
        "world": {
          "type": "object",
          "properties": {
            "min": { "$ref": "#/definitions/position" },
            "max": { "$ref": "#/definitions/position" }
          }
        }
      }
    },
    "estimates": {
      "type": "object",
      "required": ["blockCount"],
      "properties": {
        "blockCount": { "type": "integer", "minimum": 0 },
        "weCommandCount": { "type": "integer", "minimum": 0 },
        "vanillaBlockCount": { "type": "integer", "minimum": 0 },
        "estimatedTimeMs": { "type": "integer", "minimum": 0 }
      }
    },
    "safety": {
      "type": "object",
      "properties": {
        "maxBlocks": { "type": "integer", "minimum": 1 },
        "maxHeight": { "type": "integer", "minimum": 1, "maximum": 256 },
        "allowProtectedRegions": { "type": "boolean", "default": false },
        "forbiddenBlocks": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "validation": {
      "type": "object",
      "properties": {
        "profile": { "type": "string" },
        "qualityScore": { "type": "number", "minimum": 0, "maximum": 1 },
        "qualityGrade": { "type": "string", "enum": ["A", "B", "C", "D", "F"] },
        "warnings": {
          "type": "array",
          "items": { "type": "object" }
        },
        "validated": { "type": "boolean" },
        "validatedAt": { "type": "string", "format": "date-time" }
      }
    },
    "payload": {
      "type": "object",
      "description": "Kind-specific payload"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "createdAt": { "type": "string", "format": "date-time" },
        "source": { "type": "string", "enum": ["v1", "v2", "manual"] },
        "prompt": { "type": "string" },
        "intentId": { "type": "string" }
      }
    }
  },
  "definitions": {
    "position": {
      "type": "object",
      "required": ["x", "y", "z"],
      "properties": {
        "x": { "type": "integer" },
        "y": { "type": "integer" },
        "z": { "type": "integer" }
      }
    }
  }
}
